#!/bin/bash

function reset {
  if [ ! -d "./bundler" ]; then
    mkdir bundler/
  fi

  # we explicitly don't delete registry database
  rm -f ./bundler/*
  rm -f ./data/appstore.sq3
  rm -f ./data/hospital.sq3
  rm -f ./data/records.sq3
  rm -f ./data/archive.sq3
  rm -f ./data/explorer.sq3
  rm -f ./data/timeclock.sq3
  rm -f ./data/arcade.sq3
  rm -f ./data/chat.sq3
  rm -f ./data/database.sq3
  rm -f ./data/bank.sq3
  # rm -f ./data/registry.sq3
  rm -f ./data/escrow.sq3
  # rm -f ./data/rewards.sq3
  rm -f ./data/forum.sq3
  rm -f ./data/tutorial.sq3
  rm -f ./data/log.txt
  rm -f ./data/*.sq3-journal
  find ./data/blocks/ -name '*.blk' | xargs rm -r
  rm -f ./data/shashmaps/*.smap
  rm -f ./data/blocks/*.zip
  rm -f ./data/blocks/*.segadd
  rm -f ./data/tmp/*.blk
  rm -f ./data/tmp/*.zip
  rm -f ./config/options

  rm -rf ./mods/appstore/mods
  mkdir ./mods/appstore/mods
  rm -f ./mods/appstore/bundler/dist/*


  rm -f ./mods/registry/web/addresses.txt
  rm -f ./mods/appstore/mods/*
  rm -rf ./mods/appstore/bundler/mods/*
  rm -f ./mods/appstore/bundler/dist/*
  rm -f ./mods/appstore/bundler/*.js
  rm -f ./mods/appstore/bundler/*.json
  rm -f ./logs/*

  #let the system know that users pre-existed a reset.
  echo "update users set latest_tx = -1;" | sqlite3 ./data/rewards.sq3
  
  if [ -f config/options.conf ]; then
    cp config/options.conf config/options
  fi

  if [ ! -f config/modules.config.js ]; then
    cp config/modules.default.js config/modules.config.js
  fi
}

case $1 in
  "nuke")
    echo ""
    echo ""
    echo "     _.-^^---....,,--        "
    echo " _--                  --_    "
    echo " <                        >) "
    echo " |                         | "
    echo "  \._                   _./  "
    echo "     '''--. . , ; .--'''     "
    echo "          | |   |            "
    echo "       .-=||  | |=-.         "
    echo "        -=#$%&%$#=-'         "
    echo "          | ;  :|            "
    echo "      .,-#%&$@%#&#~,         "
    echo "  -------------------------  "
    echo "  NUKING YOUR SAITO INSTALL  "
    echo "  -------------------------  "
    echo "  (resetting configuration)  "
    echo ""
    echo ""
    rm -f ./data/registry.sq3
    reset
    ;;
  "reset")
    reset
    ;;
  *)
    ;;
esac

if [ ! -f ./config/modules.config.js ]; then
  cp ./config/modules.default.js ./config/modules.config.js
fi

npm run build

cat ./lib/saito/boot.js ./web/saito/saito.js > ./web/saito/saito2.js
mv -f ./web/saito/saito2.js ./web/saito/saito.js

echo ""
echo "///////////////"
echo "// IMPORTANT //"
echo "///////////////"
echo ""
echo "Saito will default to running on a local, private network for "
echo "development and testing unless you create a configuration file"
echo "specifying a connection point to the public network.          "
echo ""
echo "You can start Saito by running: "
echo ""
echo "$> npm start "
echo ""
echo ""